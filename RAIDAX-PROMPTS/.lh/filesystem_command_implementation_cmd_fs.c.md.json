{
    "sourceFile": "filesystem_command_implementation_cmd_fs.c.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1751971785224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1751971796098,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-# Language-Agnostic Specification: Filesystem Commands Implementation\r\n+#  Specification: Filesystem Commands Implementation\r\n \r\n ## 1. Module Purpose\r\n This module implements secure filesystem operations for the CloudCoin RAIDA system. It provides authenticated file management capabilities with robust path traversal protection, enabling secure storage and retrieval of objects within a sandboxed directory structure.\r\n \r\n"
                }
            ],
            "date": 1751971785224,
            "name": "Commit-0",
            "content": "# Language-Agnostic Specification: Filesystem Commands Implementation\r\n\r\n## 1. Module Purpose\r\nThis module implements secure filesystem operations for the CloudCoin RAIDA system. It provides authenticated file management capabilities with robust path traversal protection, enabling secure storage and retrieval of objects within a sandboxed directory structure.\r\n\r\n## 2. System Architecture Overview\r\n\r\n### 2.1 Core Components\r\n- **Authenticated File Operations**: Admin key-based access control for all operations\r\n- **Path Traversal Protection**: Real path resolution and validation for security\r\n- **Sandboxed Environment**: All operations restricted to designated Folders directory\r\n- **Binary File Support**: Complete file content handling for arbitrary data types\r\n- **Cryptographic Key Management**: Specialized key file retrieval functionality\r\n\r\n### 2.2 Security Model\r\n- **Admin Authentication**: 16-byte admin key required for all operations\r\n- **Directory Sandboxing**: All file paths restricted to base Folders directory\r\n- **Path Validation**: Real path resolution prevents traversal attacks\r\n- **File Type Validation**: Regular file verification for all operations\r\n\r\n## 3. System Constants and Configuration\r\n\r\n### 3.1 Security Constants\r\n```\r\nPATH_MAX = maximum path length (platform-specific, typically 4096)\r\nADMIN_KEY_SIZE = 16 bytes\r\nBASE_DIRECTORY = \"{config.cwd}/Folders/\"\r\nFILE_PERMISSIONS = 0644 (rw-r--r--)\r\n```\r\n\r\n### 3.2 Request Format Constants\r\n```\r\nGET_OBJECT_MIN_SIZE = 35 bytes      // 16 admin + 16 challenge + 1 path + 2 EOF\r\nPUT_OBJECT_MIN_SIZE = 40 bytes      // 16 admin + 16 challenge + 4 size + 1 filename + 1 content + 2 EOF\r\nRM_OBJECT_MIN_SIZE = 35 bytes       // 16 admin + 16 challenge + 1 path + 2 EOF\r\n```\r\n\r\n### 3.3 Status Response Codes\r\n```\r\nSTATUS_SUCCESS = successful operation\r\nERROR_INVALID_PACKET_LENGTH = malformed request size\r\nERROR_ADMIN_AUTH = authentication failure or security violation\r\nERROR_INVALID_PARAMETER = invalid path or parameter\r\nERROR_FILE_NOT_EXIST = requested file not found\r\nERROR_FILE_EXISTS = file already exists (for creation operations)\r\nERROR_FILESYSTEM = file I/O operation failure\r\nERROR_MEMORY_ALLOC = memory allocation failure\r\n```\r\n\r\n## 4. Core Command Implementations\r\n\r\n### 4.1. cmd_get_object\r\n**Purpose**: Retrieves file content from the sandboxed filesystem.\r\n\r\n**Request Format**:\r\n```\r\n[16 bytes Challenge Header]\r\n[16 bytes Admin Key]\r\n[Variable length File Path]\r\n[2 bytes EOF trailer]\r\nMinimum size: 35 bytes\r\n```\r\n\r\n**Security Validation**:\r\n1. **Request Size Check**: Verify minimum 35 bytes\r\n2. **Admin Authentication**: Compare admin key with configured value\r\n3. **Path Length Validation**: Ensure path length < PATH_MAX\r\n4. **Path Extraction**: Calculate path length as (body_size - 16 - 18)\r\n\r\n**Path Security Processing**:\r\n1. **Base Path Construction**: Combine config.cwd + \"/Folders/\" + user_path\r\n2. **Real Path Resolution**: Use realpath() to resolve absolute path\r\n3. **Sandbox Validation**: Verify resolved path starts with base directory\r\n4. **Traversal Detection**: Reject paths outside sandbox with ERROR_ADMIN_AUTH\r\n\r\n**File Operations**:\r\n1. **File Existence**: Use stat() to verify file exists and is regular file\r\n2. **Size Determination**: Extract file size from stat structure\r\n3. **Memory Allocation**: Allocate output buffer of exact file size\r\n4. **File Reading**: Open file read-only and read entire content\r\n5. **Response Preparation**: Set output buffer and STATUS_SUCCESS\r\n\r\n**Error Handling**:\r\n- Path resolution failure: ERROR_FILE_NOT_EXIST\r\n- Non-regular file: ERROR_INVALID_PARAMETER\r\n- File I/O errors: ERROR_FILESYSTEM\r\n- Memory allocation failure: ERROR_MEMORY_ALLOC\r\n\r\n### 4.2. cmd_put_object\r\n**Purpose**: Stores file content in the sandboxed filesystem.\r\n\r\n**Request Format**:\r\n```\r\n[16 bytes Challenge Header]\r\n[16 bytes Admin Key]\r\n[4 bytes File Size (big-endian)]\r\n[Variable length Filename (null-terminated)]\r\n[Variable length File Content]\r\n[2 bytes EOF trailer]\r\nMinimum size: 40 bytes\r\n```\r\n\r\n**Security Validation**:\r\n1. **Request Size Check**: Verify minimum 40 bytes\r\n2. **Admin Authentication**: Compare admin key with configured value\r\n3. **Size Extraction**: Get file size from bytes 16-19 using get_u32()\r\n4. **Filename Validation**: Extract null-terminated filename, validate length\r\n\r\n**Body Size Verification**:\r\n- **Expected Size**: 16 + 4 + filename_length + 1 + file_size + 2\r\n- **Actual Size**: Compare with ci->body_size\r\n- **Mismatch Handling**: Return ERROR_INVALID_PACKET_LENGTH\r\n\r\n**Path Security Processing**:\r\n1. **Directory Resolution**: Resolve directory portion of target path\r\n2. **Directory Validation**: Ensure target directory exists and is within sandbox\r\n3. **Path Construction**: Build full target path within validated directory\r\n4. **Traversal Prevention**: Reject attempts to write outside sandbox\r\n\r\n**File Operations**:\r\n1. **File Creation**: Open with O_WRONLY | O_CREAT | O_TRUNC flags\r\n2. **Permission Setting**: Set file permissions to 0644\r\n3. **Content Writing**: Write exact file_size bytes from payload\r\n4. **Write Verification**: Ensure all bytes written successfully\r\n5. **File Closure**: Close file descriptor and verify success\r\n\r\n**Error Handling**:\r\n- Directory doesn't exist: ERROR_FILE_NOT_EXIST\r\n- Path traversal attempt: ERROR_ADMIN_AUTH\r\n- File creation failure: ERROR_FILESYSTEM\r\n- Write operation failure: ERROR_FILESYSTEM\r\n\r\n### 4.3. cmd_rm_object\r\n**Purpose**: Removes file from the sandboxed filesystem.\r\n\r\n**Request Format**:\r\n```\r\n[16 bytes Challenge Header]\r\n[16 bytes Admin Key]\r\n[Variable length File Path]\r\n[2 bytes EOF trailer]\r\nMinimum size: 35 bytes\r\n```\r\n\r\n**Security Validation**:\r\n1. **Request Size Check**: Verify minimum 35 bytes\r\n2. **Admin Authentication**: Compare admin key with configured value\r\n3. **Path Length Validation**: Ensure path length < PATH_MAX\r\n4. **Path Extraction**: Calculate path length as (body_size - 16 - 18)\r\n\r\n**Path Security Processing**:\r\n1. **Base Path Construction**: Combine config.cwd + \"/Folders/\" + user_path\r\n2. **Real Path Resolution**: Use realpath() to resolve absolute path\r\n3. **File Existence**: Verify file exists before attempting removal\r\n4. **Sandbox Validation**: Ensure resolved path within base directory\r\n\r\n**File Operations**:\r\n1. **Removal Operation**: Use remove() system call to delete file\r\n2. **Operation Verification**: Check return value for success\r\n3. **Status Setting**: Set STATUS_SUCCESS on successful removal\r\n\r\n**Error Handling**:\r\n- File doesn't exist: ERROR_FILE_NOT_EXIST\r\n- Path traversal attempt: ERROR_ADMIN_AUTH\r\n- Removal failure: ERROR_FILESYSTEM\r\n\r\n## 5. Utility Functions\r\n\r\n### 5.1. get_crypto_key(ticker, size_output)\r\n**Purpose**: Retrieves cryptographic key content from filesystem for internal use.\r\n\r\n**Parameters**:\r\n- ticker: String identifier for the key file\r\n- size_output: Pointer to integer for returning file size\r\n\r\n**Processing Logic**:\r\n1. **Path Construction**: Build path as \"{config.cwd}/Folders/{ticker}\"\r\n2. **File Validation**: Check file existence and regular file status\r\n3. **Size Determination**: Use stat() to get file size\r\n4. **Memory Allocation**: Allocate buffer for entire file content\r\n5. **File Reading**: Read complete file content into buffer\r\n6. **Size Return**: Set size_output to actual bytes read\r\n\r\n**Return Behavior**:\r\n- **Success**: Return pointer to allocated buffer with key content\r\n- **Failure**: Return NULL for any error condition\r\n- **Caller Responsibility**: Free returned buffer when finished\r\n\r\n**Error Conditions**:\r\n- File access failure: Return NULL\r\n- File stat failure: Return NULL\r\n- Non-regular file: Return NULL\r\n- Memory allocation failure: Return NULL\r\n- File read failure: Return NULL and free buffer\r\n\r\n## 6. Security Implementation Requirements\r\n\r\n### 6.1 Path Traversal Prevention\r\n- **Real Path Resolution**: Use realpath() to resolve symbolic links and relative paths\r\n- **Absolute Path Validation**: Compare resolved paths with base directory\r\n- **String Prefix Checking**: Use strncmp() to verify paths start with base directory\r\n- **Rejection Response**: Use ERROR_ADMIN_AUTH to avoid revealing path structure\r\n\r\n### 6.2 Admin Authentication\r\n- **Key Comparison**: Use memcmp() for constant-time comparison\r\n- **Key Storage**: Admin key stored in configuration structure\r\n- **Authentication Failure**: Return ERROR_ADMIN_AUTH immediately\r\n- **Key Validation**: Required for every filesystem operation\r\n\r\n### 6.3 Sandbox Enforcement\r\n- **Base Directory**: All operations limited to \"{config.cwd}/Folders/\"\r\n- **Directory Validation**: Ensure all resolved paths within sandbox\r\n- **Access Control**: No operations permitted outside base directory\r\n- **Error Responses**: Generic errors to prevent information disclosure\r\n\r\n## 7. File Operation Safety\r\n\r\n### 7.1 Memory Management\r\n- **Buffer Allocation**: Allocate exact file size for content\r\n- **Error Cleanup**: Free allocated buffers on all error paths\r\n- **Size Verification**: Verify read/write operations match expected sizes\r\n- **Resource Management**: Close file descriptors on all exit paths\r\n\r\n### 7.2 File System Interaction\r\n- **File Type Validation**: Use S_ISREG() to verify regular files only\r\n- **Permission Setting**: Set appropriate file permissions (0644)\r\n- **Atomic Operations**: Use appropriate flags for file creation/truncation\r\n- **Error Propagation**: Convert system errors to appropriate status codes\r\n\r\n### 7.3 Input Validation\r\n- **Size Limits**: Enforce PATH_MAX limits on all path inputs\r\n- **Null Termination**: Ensure proper string termination for paths\r\n- **Length Calculation**: Verify calculated lengths match actual data\r\n- **Buffer Bounds**: Prevent buffer overflows in all operations\r\n\r\n## 8. Error Handling and Logging\r\n\r\n### 8.1 Error Classification\r\n- **Authentication Errors**: Admin key validation failures\r\n- **Security Errors**: Path traversal attempts and sandbox violations\r\n- **Filesystem Errors**: File I/O operation failures\r\n- **Parameter Errors**: Invalid request format or parameters\r\n\r\n### 8.2 Logging Strategy\r\n- **Security Events**: Log all authentication failures and traversal attempts\r\n- **Operation Success**: Debug log successful file operations with paths\r\n- **Error Context**: Include system error messages with file operations\r\n- **Path Information**: Log resolved paths for debugging (after validation)\r\n\r\n### 8.3 Error Response Strategy\r\n- **Generic Errors**: Use ERROR_ADMIN_AUTH for security violations\r\n- **Specific Errors**: Use appropriate codes for legitimate failures\r\n- **Information Hiding**: Avoid revealing internal path structure\r\n- **Consistent Responses**: Same error code for similar security violations\r\n\r\n## 9. Performance Considerations\r\n\r\n### 9.1 File I/O Optimization\r\n- **Single Read/Write**: Complete file operations in single system calls\r\n- **Buffer Sizing**: Allocate exact file size to minimize memory usage\r\n- **File Descriptor Management**: Minimize open file descriptor lifetime\r\n- **Path Caching**: Reuse resolved base paths where possible\r\n\r\n### 9.2 Memory Efficiency\r\n- **Dynamic Allocation**: Allocate only required memory for file content\r\n- **Early Cleanup**: Free resources immediately after use\r\n- **Error Path Cleanup**: Ensure no memory leaks on error conditions\r\n- **Size Validation**: Prevent excessive memory allocation attempts\r\n\r\n### 9.3 Security Performance\r\n- **Path Resolution**: Use efficient realpath() for security validation\r\n- **String Operations**: Use optimized string comparison functions\r\n- **Authentication**: Constant-time comparison for admin keys\r\n- **Validation Order**: Perform cheap validations before expensive operations\r\n\r\n## 10. Integration Requirements\r\n\r\n### 10.1 Configuration Dependencies\r\n- **Admin Key**: Access to config.admin_key for authentication\r\n- **Base Directory**: Access to config.cwd for path construction\r\n- **Path Limits**: Platform-specific PATH_MAX constant\r\n\r\n### 10.2 System Dependencies\r\n- **File System**: POSIX file system operations (open, read, write, remove)\r\n- **Path Resolution**: realpath() function for security validation\r\n- **Memory Management**: malloc/free for dynamic buffer allocation\r\n- **String Operations**: Standard string manipulation functions\r\n\r\n### 10.3 Protocol Integration\r\n- **Connection Info**: Access to body_size, output, output_size, command_status\r\n- **Payload Access**: get_body_payload() function for request data\r\n- **Status Codes**: Protocol-defined error and success constants\r\n- **Response Format**: Standard response preparation mechanism\r\n\r\nThis specification provides complete implementation guidance for secure filesystem operations while remaining language-agnostic and accurately reflecting the security-focused implementation requirements."
        }
    ]
}